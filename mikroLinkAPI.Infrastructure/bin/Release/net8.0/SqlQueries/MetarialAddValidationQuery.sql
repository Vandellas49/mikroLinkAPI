CREATE TABLE #TempCsv_[@tempName] (ComponentId NVARCHAR(MAX), Serinumarasi NVARCHAR(MAX), girisIrsaliye NVARCHAR(MAX), saglam NVARCHAR(MAX), arzali NVARCHAR(MAX), hurda NVARCHAR(MAX), raf NVARCHAR(70), malzemeTuru NVARCHAR(100) ); 
;BULK INSERT #TempCsv_[@tempName] FROM '{filepath}' WITH ( FIELDTERMINATOR = ',', ROWTERMINATOR = '\n', FIRSTROW = 2,FORMAT='CSV',CODEPAGE = '65001' );
CREATE TABLE #Hatalar_[@tempName] ( Id INT PRIMARY KEY IDENTITY(1,1), HataKodu INT, HataMesaji NVARCHAR(500), ComponentId NVARCHAR(MAX) NULL, Serinumarasi NVARCHAR(MAX) NULL, MalzemeTuru NVARCHAR(MAX) NULL ); 
INSERT INTO #Hatalar_[@tempName] (HataKodu, HataMesaji, ComponentId) SELECT 6, 'Zorunlu alanlardan biri boş bırakılamaz.', ComponentId FROM #TempCsv_[@tempName] WHERE ComponentId IS NULL OR girisIrsaliye IS NULL OR raf IS NULL OR malzemeTuru IS NULL OR Serinumarasi IS NULL; 
INSERT INTO #Hatalar_[@tempName] (HataKodu, HataMesaji,Serinumarasi) SELECT 1, 'Seri numarası geçici tabloda birden fazla kez bulunuyor.', Serinumarasi FROM #TempCsv_[@tempName] where Serinumarasi<>'SarfMalzeme'  GROUP BY Serinumarasi HAVING COUNT(*) > 1; 
INSERT INTO #Hatalar_[@tempName] (HataKodu, HataMesaji,Serinumarasi) SELECT 1, 'Seri numarası ComponentSerial tablosunda zaten mevcut.', t.Serinumarasi FROM #TempCsv_[@tempName] AS t JOIN ComponentSerial AS cs ON t.Serinumarasi<>'SarfMalzeme' and t.Serinumarasi = cs.SeriNo; 
INSERT INTO #Hatalar_[@tempName] (HataKodu, HataMesaji, ComponentId) SELECT 2, 'Parça kodu Component tablosunda bulunamadı.', t.ComponentId FROM #TempCsv_[@tempName] AS t LEFT JOIN Component AS c ON t.ComponentId = c.Id WHERE c.Id IS NULL;
INSERT INTO #Hatalar_[@tempName] (HataKodu, HataMesaji, ComponentId, Serinumarasi) SELECT 3, 'Parça kodu Sarf olarak tanımlanmış ama Seri numarası girilmiş.', t.ComponentId, t.Serinumarasi FROM #TempCsv_[@tempName] AS t JOIN Component AS c ON t.ComponentId = c.Id WHERE c.MalzemeTuru = 1 AND t.Serinumarasi <> 'SarfMalzeme'; 
INSERT INTO #Hatalar_[@tempName] (HataKodu, HataMesaji, ComponentId) SELECT 4, 'Sağlam, Arızalı veya Hurda negatif değer içeremez.', ComponentId FROM #TempCsv_[@tempName] WHERE (ISNUMERIC(saglam) = 1 AND CAST(saglam AS INT) < 0) OR (ISNUMERIC(arzali) = 1 AND CAST(arzali AS INT) < 0) OR (ISNUMERIC(hurda) = 1 AND CAST(hurda AS INT) < 0); 
INSERT INTO #Hatalar_[@tempName] (HataKodu, HataMesaji, ComponentId) SELECT 5, 'Parça kodu Seri ise Sağlam + Arızalı + Hurda toplamı 1 olmalıdır.', t.ComponentId FROM #TempCsv_[@tempName] AS t JOIN Component AS c ON t.ComponentId = c.Id WHERE c.MalzemeTuru = 0 AND (ISNULL(CAST(t.saglam AS INT), 0) + ISNULL(CAST(t.arzali AS INT), 0) + ISNULL(CAST(t.hurda AS INT), 0)) != 1; 
INSERT INTO #Hatalar_[@tempName] (HataKodu, HataMesaji, ComponentId, MalzemeTuru) SELECT 7, 'Malzeme Türü MalzemeTuru tablosunda tanımlı değil.', ComponentId, malzemeTuru FROM #TempCsv_[@tempName] AS t LEFT JOIN MalzemeTuru AS mt ON t.malzemeTuru = mt.Value WHERE mt.Value IS NULL;
SELECT * FROM #Hatalar_[@tempName]; 
DROP TABLE #TempCsv_[@tempName];
DROP TABLE #Hatalar_[@tempName];